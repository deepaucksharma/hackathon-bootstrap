domain: INFRA
type: MESSAGE_QUEUE_BROKER

# Synthesis rules for creating broker entities from telemetry data
synthesis:
  rules:
    # Standard Kafka broker synthesis
    - identifier: [clusterName, broker.id, hostname]
      name: hostname
      encodeIdentifierInGUID: true
      conditions:
        - attribute: eventType
          value: KafkaBrokerSample
        - attribute: broker.id
          present: true
        - attribute: clusterName
          present: true
      tags:
        broker.id:
          entityTagName: brokerId
        hostname:
        clusterName:
          entityTagName: mq.cluster.name
        provider:
          entityTagName: mq.provider
        environment:
        cloud.provider:
        cloud.region:
        cloud.availability_zone:
        aws.instanceId:
        k8s.cluster.name:
        k8s.namespace.name:
        k8s.pod.name:
        instrumentation.provider:
          
    # AWS MSK broker synthesis
    - identifier: [clusterArn, broker.id]
      name: [clusterName, '-broker-', broker.id]
      encodeIdentifierInGUID: true
      conditions:
        - attribute: eventType
          value: AwsMskBrokerSample
        - attribute: clusterArn
          present: true
        - attribute: broker.id
          present: true
      tags:
        clusterArn:
          entityTagName: aws.arn
        broker.id:
          entityTagName: brokerId
        instanceType:
          entityTagName: aws.instanceType
        aws.region:
        aws.availabilityZone:
          entityTagName: cloud.availability_zone
        provider:
          entityTagName: mq.provider
        environment:
        instrumentation.provider:
          
    # OpenTelemetry compatibility
    - identifier: [service.instance.id]
      name: [service.name]
      encodeIdentifierInGUID: true
      conditions:
        - attribute: eventType
          value: Metric
        - attribute: metricName
          prefix: messaging.kafka.broker.
        - attribute: service.instance.id
          present: true
        - attribute: newrelic.source
          value: api.metrics.otlp
      tags:
        service.name:
        service.namespace:
        service.instance.id:
          entityTagName: broker.id
        host.name:
          entityTagName: hostname
        telemetry.sdk.name:
        telemetry.sdk.version:
        telemetry.sdk.language:
        cloud.provider:
        cloud.region:
        k8s.cluster.name:
      legacyFeatures:
        overrideGuidType: true

# Golden tags are the most important tags for this entity type
goldenTags:
  - account
  - accountId
  - mq.provider
  - mq.cluster.name
  - environment
  - hostname
  - cloud.provider
  - cloud.region
  - cloud.availability_zone
  - k8s.cluster.name
  - k8s.pod.name
  - instrumentation.provider

# Entity configuration
configuration:
  entityExpirationTime: EIGHT_DAYS
  alertable: true