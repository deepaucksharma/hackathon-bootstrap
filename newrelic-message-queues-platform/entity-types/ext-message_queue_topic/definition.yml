domain: EXT
type: MESSAGE_QUEUE_TOPIC

# Synthesis rules for creating topic entities from telemetry data
synthesis:
  rules:
    # Standard Kafka topic synthesis
    - identifier: [clusterName, topic]
      name: topic
      encodeIdentifierInGUID: true
      conditions:
        - attribute: eventType
          value: KafkaTopicSample
        - attribute: topic
          present: true
        - attribute: clusterName
          present: true
      tags:
        topic:
          entityTagName: topicName
        clusterName:
          entityTagName: mq.cluster.name
        provider:
          entityTagName: mq.provider
        environment:
        topic.classification:
        retention.ms:
          entityTagName: topic.retention.ms
        compression.type:
          entityTagName: topic.compression.type
        cleanup.policy:
          entityTagName: topic.cleanup.policy
        cloud.provider:
        cloud.region:
        k8s.cluster.name:
        k8s.namespace.name:
        instrumentation.provider:
          
    # AWS MSK topic synthesis
    - identifier: [clusterArn, topicName]
      name: topicName
      encodeIdentifierInGUID: true
      conditions:
        - attribute: eventType
          value: AwsMskTopicSample
        - attribute: clusterArn
          present: true
        - attribute: topicName
          present: true
      tags:
        topicName:
        clusterArn:
          entityTagName: aws.arn
        clusterName:
          entityTagName: mq.cluster.name
        aws.region:
        provider:
          entityTagName: mq.provider
        environment:
        instrumentation.provider:
          
    # OpenTelemetry compatibility
    - identifier: [messaging.destination.name, service.namespace]
      name: messaging.destination.name
      encodeIdentifierInGUID: true
      conditions:
        - attribute: eventType
          value: Metric
        - attribute: metricName
          prefix: messaging.kafka.topic.
        - attribute: messaging.destination.name
          present: true
        - attribute: newrelic.source
          value: api.metrics.otlp
      tags:
        messaging.system:
          entityTagName: mq.provider
        messaging.destination.name:
          entityTagName: topicName
        messaging.destination.kind:
        service.name:
        service.namespace:
          entityTagName: mq.cluster.name
        telemetry.sdk.name:
        telemetry.sdk.version:
        telemetry.sdk.language:
        cloud.provider:
        cloud.region:
        k8s.cluster.name:
      legacyFeatures:
        overrideGuidType: true

# Golden tags are the most important tags for this entity type
goldenTags:
  - account
  - accountId
  - mq.provider
  - mq.cluster.name
  - environment
  - topic.classification
  - cloud.provider
  - cloud.region
  - k8s.cluster.name
  - instrumentation.provider

# Entity configuration
configuration:
  entityExpirationTime: EIGHT_DAYS
  alertable: true