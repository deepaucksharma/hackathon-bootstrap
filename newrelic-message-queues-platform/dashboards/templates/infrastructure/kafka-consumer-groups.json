{
  "name": "Kafka Consumer Groups - Infrastructure",
  "description": "Monitor Kafka consumer groups, lag metrics, and consumption patterns from nri-kafka data",
  "permissions": "PUBLIC_READ_WRITE",
  "pages": [
    {
      "name": "Consumer Group Overview",
      "description": "Overview of all consumer groups and their health",
      "widgets": [
        {
          "title": "Consumer Group Health Status",
          "layout": {
            "column": 1,
            "row": 1,
            "width": 4,
            "height": 3
          },
          "visualization": {
            "id": "viz.billboard"
          },
          "configuration": {
            "facet": {
              "showOtherSeries": false
            },
            "nrqlQueries": [
              {
                "accountId": "{{accountId}}",
                "query": "FROM MessageQueue SELECT count(*) WHERE entityType = 'MESSAGE_QUEUE_CONSUMER_GROUP' AND consumerGroup.state = 'STABLE' AS 'Stable Groups', count(*) WHERE entityType = 'MESSAGE_QUEUE_CONSUMER_GROUP' AND consumerGroup.state = 'REBALANCING' AS 'Rebalancing', count(*) WHERE entityType = 'MESSAGE_QUEUE_CONSUMER_GROUP' AND consumerGroup.state = 'DEAD' AS 'Dead Groups' SINCE 5 minutes ago"
              }
            ],
            "thresholds": [
              {
                "alertSeverity": "WARNING",
                "value": 1
              }
            ]
          }
        },
        {
          "title": "Total Consumer Lag",
          "layout": {
            "column": 5,
            "row": 1,
            "width": 4,
            "height": 3
          },
          "visualization": {
            "id": "viz.billboard"
          },
          "configuration": {
            "facet": {
              "showOtherSeries": false
            },
            "nrqlQueries": [
              {
                "accountId": "{{accountId}}",
                "query": "FROM MessageQueue SELECT sum(consumerGroup.totalLag) AS 'Total Lag', average(consumerGroup.avgLag) AS 'Avg Lag per Group', max(consumerGroup.maxLag) AS 'Max Lag' WHERE entityType = 'MESSAGE_QUEUE_CONSUMER_GROUP' SINCE 5 minutes ago"
              }
            ],
            "thresholds": [
              {
                "alertSeverity": "WARNING",
                "value": 10000
              },
              {
                "alertSeverity": "CRITICAL",
                "value": 100000
              }
            ]
          }
        },
        {
          "title": "Consumption Rate",
          "layout": {
            "column": 9,
            "row": 1,
            "width": 4,
            "height": 3
          },
          "visualization": {
            "id": "viz.billboard"
          },
          "configuration": {
            "facet": {
              "showOtherSeries": false
            },
            "nrqlQueries": [
              {
                "accountId": "{{accountId}}",
                "query": "FROM MessageQueue SELECT sum(consumerGroup.messagesConsumedPerSecond) AS 'Messages/sec', sum(consumerGroup.bytesConsumedPerSecond) / 1024 / 1024 AS 'MB/sec' WHERE entityType = 'MESSAGE_QUEUE_CONSUMER_GROUP' SINCE 5 minutes ago"
              }
            ]
          }
        },
        {
          "title": "Consumer Group Lag Trend",
          "layout": {
            "column": 1,
            "row": 4,
            "width": 8,
            "height": 3
          },
          "visualization": {
            "id": "viz.line"
          },
          "configuration": {
            "facet": {
              "showOtherSeries": false
            },
            "nrqlQueries": [
              {
                "accountId": "{{accountId}}",
                "query": "FROM MessageQueue SELECT average(consumerGroup.totalLag) WHERE entityType = 'MESSAGE_QUEUE_CONSUMER_GROUP' FACET consumerGroupId TIMESERIES AUTO SINCE 1 hour ago"
              }
            ],
            "yAxisLeft": {
              "zero": true
            }
          }
        },
        {
          "title": "Top Lagging Consumer Groups",
          "layout": {
            "column": 9,
            "row": 4,
            "width": 4,
            "height": 3
          },
          "visualization": {
            "id": "viz.bar"
          },
          "configuration": {
            "facet": {
              "showOtherSeries": false
            },
            "nrqlQueries": [
              {
                "accountId": "{{accountId}}",
                "query": "FROM MessageQueue SELECT latest(consumerGroup.totalLag) AS 'Total Lag' WHERE entityType = 'MESSAGE_QUEUE_CONSUMER_GROUP' FACET consumerGroupId SINCE 5 minutes ago LIMIT 10"
              }
            ]
          }
        },
        {
          "title": "Consumer Group Members",
          "layout": {
            "column": 1,
            "row": 7,
            "width": 6,
            "height": 3
          },
          "visualization": {
            "id": "viz.table"
          },
          "configuration": {
            "facet": {
              "showOtherSeries": false
            },
            "nrqlQueries": [
              {
                "accountId": "{{accountId}}",
                "query": "FROM MessageQueue SELECT latest(consumerGroup.memberCount) AS 'Members', latest(consumerGroup.state) AS 'State', latest(consumerGroup.topics) AS 'Topics' WHERE entityType = 'MESSAGE_QUEUE_CONSUMER_GROUP' FACET consumerGroupId AS 'Consumer Group' SINCE 5 minutes ago LIMIT 20"
              }
            ]
          }
        },
        {
          "title": "Consumption Performance by Group",
          "layout": {
            "column": 7,
            "row": 7,
            "width": 6,
            "height": 3
          },
          "visualization": {
            "id": "viz.table"
          },
          "configuration": {
            "facet": {
              "showOtherSeries": false
            },
            "nrqlQueries": [
              {
                "accountId": "{{accountId}}",
                "query": "FROM MessageQueue SELECT rate(sum(consumerGroup.messagesConsumedPerSecond), 1 second) AS 'Msg/sec', average(consumerGroup.processingTimeMs) AS 'Avg Processing (ms)', latest(consumerGroup.offsetCommitRate) AS 'Commits/sec' WHERE entityType = 'MESSAGE_QUEUE_CONSUMER_GROUP' FACET consumerGroupId AS 'Consumer Group' SINCE 5 minutes ago LIMIT 20"
              }
            ]
          }
        }
      ]
    },
    {
      "name": "Lag Analysis",
      "description": "Detailed consumer lag analysis and trends",
      "widgets": [
        {
          "title": "Lag Distribution Heatmap",
          "layout": {
            "column": 1,
            "row": 1,
            "width": 12,
            "height": 3
          },
          "visualization": {
            "id": "viz.heatmap"
          },
          "configuration": {
            "nrqlQueries": [
              {
                "accountId": "{{accountId}}",
                "query": "FROM MessageQueue SELECT histogram(consumerGroup.totalLag, 10, 20) WHERE entityType = 'MESSAGE_QUEUE_CONSUMER_GROUP' FACET consumerGroupId SINCE 1 hour ago"
              }
            ]
          }
        },
        {
          "title": "Max Lag by Topic",
          "layout": {
            "column": 1,
            "row": 4,
            "width": 6,
            "height": 3
          },
          "visualization": {
            "id": "viz.bar"
          },
          "configuration": {
            "facet": {
              "showOtherSeries": false
            },
            "nrqlQueries": [
              {
                "accountId": "{{accountId}}",
                "query": "FROM MessageQueue SELECT max(consumerGroup.maxLag) WHERE entityType = 'MESSAGE_QUEUE_CONSUMER_GROUP' FACET tags.topicName SINCE 30 minutes ago"
              }
            ]
          }
        },
        {
          "title": "Consumer Group Lag Alerts",
          "layout": {
            "column": 7,
            "row": 4,
            "width": 6,
            "height": 3
          },
          "visualization": {
            "id": "viz.table"
          },
          "configuration": {
            "facet": {
              "showOtherSeries": false
            },
            "nrqlQueries": [
              {
                "accountId": "{{accountId}}",
                "query": "FROM MessageQueue SELECT latest(consumerGroup.totalLag) AS 'Total Lag', latest(consumerGroup.maxLag) AS 'Max Lag', latest(consumerGroup.avgLag) AS 'Avg Lag', latest(consumerGroup.state) AS 'State' WHERE entityType = 'MESSAGE_QUEUE_CONSUMER_GROUP' AND consumerGroup.totalLag > 1000 FACET consumerGroupId AS 'Consumer Group' SINCE 5 minutes ago"
              }
            ]
          }
        },
        {
          "title": "Lag Recovery Rate",
          "layout": {
            "column": 1,
            "row": 7,
            "width": 12,
            "height": 3
          },
          "visualization": {
            "id": "viz.line"
          },
          "configuration": {
            "facet": {
              "showOtherSeries": false
            },
            "nrqlQueries": [
              {
                "accountId": "{{accountId}}",
                "query": "FROM MessageQueue SELECT derivative(average(consumerGroup.totalLag), 1 minute) AS 'Lag Change Rate' WHERE entityType = 'MESSAGE_QUEUE_CONSUMER_GROUP' FACET consumerGroupId TIMESERIES AUTO SINCE 1 hour ago"
              }
            ],
            "yAxisLeft": {
              "zero": false
            }
          }
        }
      ]
    },
    {
      "name": "Consumer Performance",
      "description": "Consumer group performance metrics and analysis",
      "widgets": [
        {
          "title": "Message Consumption Rate",
          "layout": {
            "column": 1,
            "row": 1,
            "width": 8,
            "height": 3
          },
          "visualization": {
            "id": "viz.area"
          },
          "configuration": {
            "facet": {
              "showOtherSeries": false
            },
            "nrqlQueries": [
              {
                "accountId": "{{accountId}}",
                "query": "FROM MessageQueue SELECT sum(consumerGroup.messagesConsumedPerSecond) WHERE entityType = 'MESSAGE_QUEUE_CONSUMER_GROUP' FACET consumerGroupId TIMESERIES AUTO SINCE 1 hour ago"
              }
            ]
          }
        },
        {
          "title": "Consumer Efficiency",
          "layout": {
            "column": 9,
            "row": 1,
            "width": 4,
            "height": 3
          },
          "visualization": {
            "id": "viz.pie"
          },
          "configuration": {
            "facet": {
              "showOtherSeries": true
            },
            "nrqlQueries": [
              {
                "accountId": "{{accountId}}",
                "query": "FROM MessageQueue SELECT sum(consumerGroup.messagesConsumedPerSecond) WHERE entityType = 'MESSAGE_QUEUE_CONSUMER_GROUP' FACET consumerGroupId SINCE 5 minutes ago"
              }
            ]
          }
        },
        {
          "title": "Processing Time Distribution",
          "layout": {
            "column": 1,
            "row": 4,
            "width": 6,
            "height": 3
          },
          "visualization": {
            "id": "viz.histogram"
          },
          "configuration": {
            "nrqlQueries": [
              {
                "accountId": "{{accountId}}",
                "query": "FROM MessageQueue SELECT histogram(consumerGroup.processingTimeMs, 50, 10) WHERE entityType = 'MESSAGE_QUEUE_CONSUMER_GROUP' SINCE 30 minutes ago"
              }
            ]
          }
        },
        {
          "title": "Offset Commit Patterns",
          "layout": {
            "column": 7,
            "row": 4,
            "width": 6,
            "height": 3
          },
          "visualization": {
            "id": "viz.line"
          },
          "configuration": {
            "facet": {
              "showOtherSeries": false
            },
            "nrqlQueries": [
              {
                "accountId": "{{accountId}}",
                "query": "FROM MessageQueue SELECT average(consumerGroup.offsetCommitRate) WHERE entityType = 'MESSAGE_QUEUE_CONSUMER_GROUP' FACET consumerGroupId TIMESERIES AUTO SINCE 1 hour ago"
              }
            ]
          }
        },
        {
          "title": "Consumer Group Rebalancing Events",
          "layout": {
            "column": 1,
            "row": 7,
            "width": 12,
            "height": 3
          },
          "visualization": {
            "id": "viz.table"
          },
          "configuration": {
            "facet": {
              "showOtherSeries": false
            },
            "nrqlQueries": [
              {
                "accountId": "{{accountId}}",
                "query": "FROM MessageQueue SELECT count(*) AS 'Rebalance Events' WHERE entityType = 'MESSAGE_QUEUE_CONSUMER_GROUP' AND consumerGroup.state = 'REBALANCING' FACET consumerGroupId, timestamp AS 'Time' SINCE 1 hour ago LIMIT 50"
              }
            ]
          }
        }
      ]
    }
  ]
}