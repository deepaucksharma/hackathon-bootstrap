{
  "name": "Kafka Cluster Health - Infrastructure",
  "description": "Comprehensive Kafka cluster health monitoring including brokers, topics, and consumer groups",
  "permissions": "PUBLIC_READ_WRITE",
  "pages": [
    {
      "name": "Cluster Overview",
      "description": "High-level cluster health and performance metrics",
      "widgets": [
        {
          "title": "Cluster Health Score",
          "layout": {
            "column": 1,
            "row": 1,
            "width": 3,
            "height": 3
          },
          "visualization": {
            "id": "viz.billboard"
          },
          "configuration": {
            "facet": {
              "showOtherSeries": false
            },
            "nrqlQueries": [
              {
                "accountId": "{{accountId}}",
                "query": "FROM MessageQueue SELECT latest(cluster.health.score) AS 'Health Score' WHERE entityType = 'MESSAGE_QUEUE_CLUSTER' FACET clusterName SINCE 5 minutes ago"
              }
            ],
            "thresholds": [
              {
                "alertSeverity": "WARNING",
                "value": 90
              },
              {
                "alertSeverity": "CRITICAL",
                "value": 80
              }
            ]
          }
        },
        {
          "title": "Cluster Throughput",
          "layout": {
            "column": 4,
            "row": 1,
            "width": 3,
            "height": 3
          },
          "visualization": {
            "id": "viz.billboard"
          },
          "configuration": {
            "facet": {
              "showOtherSeries": false
            },
            "nrqlQueries": [
              {
                "accountId": "{{accountId}}",
                "query": "FROM MessageQueue SELECT sum(cluster.messagesInPerSecond) + sum(cluster.messagesOutPerSecond) AS 'Total Messages/sec', sum(cluster.bytesInPerSecond) / 1024 / 1024 + sum(cluster.bytesOutPerSecond) / 1024 / 1024 AS 'Total MB/sec' WHERE entityType = 'MESSAGE_QUEUE_CLUSTER' SINCE 5 minutes ago"
              }
            ]
          }
        },
        {
          "title": "Active Brokers",
          "layout": {
            "column": 7,
            "row": 1,
            "width": 3,
            "height": 3
          },
          "visualization": {
            "id": "viz.billboard"
          },
          "configuration": {
            "facet": {
              "showOtherSeries": false
            },
            "nrqlQueries": [
              {
                "accountId": "{{accountId}}",
                "query": "FROM MessageQueue SELECT uniqueCount(brokerId) AS 'Active Brokers', sum(broker.underReplicatedPartitions) AS 'Under-replicated', sum(broker.offlinePartitions) AS 'Offline Partitions' WHERE entityType = 'MESSAGE_QUEUE_BROKER' SINCE 5 minutes ago"
              }
            ],
            "thresholds": [
              {
                "alertSeverity": "CRITICAL",
                "value": 1
              }
            ]
          }
        },
        {
          "title": "Entity Summary",
          "layout": {
            "column": 10,
            "row": 1,
            "width": 3,
            "height": 3
          },
          "visualization": {
            "id": "viz.billboard"
          },
          "configuration": {
            "facet": {
              "showOtherSeries": false
            },
            "nrqlQueries": [
              {
                "accountId": "{{accountId}}",
                "query": "FROM MessageQueue SELECT uniqueCount(entityGuid) WHERE entityType = 'MESSAGE_QUEUE_BROKER' AS 'Brokers', uniqueCount(entityGuid) WHERE entityType = 'MESSAGE_QUEUE_TOPIC' AS 'Topics', uniqueCount(entityGuid) WHERE entityType = 'MESSAGE_QUEUE_CONSUMER_GROUP' AS 'Consumer Groups' SINCE 5 minutes ago"
              }
            ]
          }
        },
        {
          "title": "Cluster Throughput Trend",
          "layout": {
            "column": 1,
            "row": 4,
            "width": 8,
            "height": 3
          },
          "visualization": {
            "id": "viz.area"
          },
          "configuration": {
            "facet": {
              "showOtherSeries": false
            },
            "nrqlQueries": [
              {
                "accountId": "{{accountId}}",
                "query": "FROM MessageQueue SELECT sum(cluster.messagesInPerSecond) AS 'Messages In', sum(cluster.messagesOutPerSecond) AS 'Messages Out' WHERE entityType = 'MESSAGE_QUEUE_CLUSTER' TIMESERIES AUTO SINCE 1 hour ago"
              }
            ],
            "colors": {
              "seriesOverrides": [
                {
                  "seriesName": "Messages In",
                  "color": "#00C781"
                },
                {
                  "seriesName": "Messages Out",
                  "color": "#F97C00"
                }
              ]
            }
          }
        },
        {
          "title": "Critical Issues",
          "layout": {
            "column": 9,
            "row": 4,
            "width": 4,
            "height": 3
          },
          "visualization": {
            "id": "viz.table"
          },
          "configuration": {
            "facet": {
              "showOtherSeries": false
            },
            "nrqlQueries": [
              {
                "accountId": "{{accountId}}",
                "query": "FROM MessageQueue SELECT latest(broker.offlinePartitions) AS 'Offline', latest(broker.underReplicatedPartitions) AS 'Under-replicated', latest(broker.cpu.usage) AS 'CPU %' WHERE entityType = 'MESSAGE_QUEUE_BROKER' AND (broker.offlinePartitions > 0 OR broker.underReplicatedPartitions > 0 OR broker.cpu.usage > 90) FACET hostname AS 'Broker' SINCE 5 minutes ago"
              }
            ]
          }
        }
      ]
    },
    {
      "name": "Broker Health",
      "description": "Detailed broker metrics and performance",
      "widgets": [
        {
          "title": "Broker CPU Usage",
          "layout": {
            "column": 1,
            "row": 1,
            "width": 6,
            "height": 3
          },
          "visualization": {
            "id": "viz.line"
          },
          "configuration": {
            "facet": {
              "showOtherSeries": false
            },
            "nrqlQueries": [
              {
                "accountId": "{{accountId}}",
                "query": "FROM MessageQueue SELECT average(broker.cpu.usage) WHERE entityType = 'MESSAGE_QUEUE_BROKER' FACET hostname TIMESERIES AUTO SINCE 30 minutes ago"
              }
            ],
            "yAxisLeft": {
              "max": 100,
              "min": 0
            }
          }
        },
        {
          "title": "Broker Memory Usage",
          "layout": {
            "column": 7,
            "row": 1,
            "width": 6,
            "height": 3
          },
          "visualization": {
            "id": "viz.line"
          },
          "configuration": {
            "facet": {
              "showOtherSeries": false
            },
            "nrqlQueries": [
              {
                "accountId": "{{accountId}}",
                "query": "FROM MessageQueue SELECT average(broker.memory.usage) WHERE entityType = 'MESSAGE_QUEUE_BROKER' FACET hostname TIMESERIES AUTO SINCE 30 minutes ago"
              }
            ],
            "yAxisLeft": {
              "max": 100,
              "min": 0
            }
          }
        },
        {
          "title": "Broker Request Latency",
          "layout": {
            "column": 1,
            "row": 4,
            "width": 6,
            "height": 3
          },
          "visualization": {
            "id": "viz.line"
          },
          "configuration": {
            "facet": {
              "showOtherSeries": false
            },
            "nrqlQueries": [
              {
                "accountId": "{{accountId}}",
                "query": "FROM MessageQueue SELECT average(broker.requestHandlerIdlePercent) AS 'Request Handler Idle %', 100 - average(broker.networkProcessorIdlePercent) AS 'Network Processor Busy %' WHERE entityType = 'MESSAGE_QUEUE_BROKER' FACET hostname TIMESERIES AUTO SINCE 30 minutes ago"
              }
            ]
          }
        },
        {
          "title": "Broker Replication Health",
          "layout": {
            "column": 7,
            "row": 4,
            "width": 6,
            "height": 3
          },
          "visualization": {
            "id": "viz.table"
          },
          "configuration": {
            "facet": {
              "showOtherSeries": false
            },
            "nrqlQueries": [
              {
                "accountId": "{{accountId}}",
                "query": "FROM MessageQueue SELECT latest(broker.underReplicatedPartitions) AS 'Under-replicated', latest(broker.offlinePartitions) AS 'Offline', latest(broker.leaderElectionRate) AS 'Leader Elections/sec', latest(broker.uncleanLeaderElections) AS 'Unclean Elections' WHERE entityType = 'MESSAGE_QUEUE_BROKER' FACET hostname AS 'Broker' SINCE 5 minutes ago"
              }
            ]
          }
        }
      ]
    },
    {
      "name": "Topic Performance",
      "description": "Topic-level metrics and analysis",
      "widgets": [
        {
          "title": "Top Topics by Throughput",
          "layout": {
            "column": 1,
            "row": 1,
            "width": 6,
            "height": 3
          },
          "visualization": {
            "id": "viz.bar"
          },
          "configuration": {
            "facet": {
              "showOtherSeries": false
            },
            "nrqlQueries": [
              {
                "accountId": "{{accountId}}",
                "query": "FROM MessageQueue SELECT sum(topic.messagesInPerSecond) + sum(topic.messagesOutPerSecond) AS 'Total Messages/sec' WHERE entityType = 'MESSAGE_QUEUE_TOPIC' FACET topicName SINCE 5 minutes ago LIMIT 10"
              }
            ]
          }
        },
        {
          "title": "Topic Size Distribution",
          "layout": {
            "column": 7,
            "row": 1,
            "width": 6,
            "height": 3
          },
          "visualization": {
            "id": "viz.pie"
          },
          "configuration": {
            "facet": {
              "showOtherSeries": true
            },
            "nrqlQueries": [
              {
                "accountId": "{{accountId}}",
                "query": "FROM MessageQueue SELECT latest(topic.sizeBytes) / 1024 / 1024 / 1024 AS 'Size (GB)' WHERE entityType = 'MESSAGE_QUEUE_TOPIC' FACET topicName SINCE 5 minutes ago LIMIT 20"
              }
            ]
          }
        },
        {
          "title": "Topic Consumer Lag",
          "layout": {
            "column": 1,
            "row": 4,
            "width": 12,
            "height": 3
          },
          "visualization": {
            "id": "viz.heatmap"
          },
          "configuration": {
            "nrqlQueries": [
              {
                "accountId": "{{accountId}}",
                "query": "FROM MessageQueue SELECT latest(consumerGroup.totalLag) WHERE entityType = 'MESSAGE_QUEUE_CONSUMER_GROUP' FACET tags.topicName, consumerGroupId SINCE 30 minutes ago"
              }
            ]
          }
        }
      ]
    },
    {
      "name": "Consumer Group Health",
      "description": "Consumer group performance and lag analysis",
      "widgets": [
        {
          "title": "Consumer Group States",
          "layout": {
            "column": 1,
            "row": 1,
            "width": 4,
            "height": 3
          },
          "visualization": {
            "id": "viz.pie"
          },
          "configuration": {
            "facet": {
              "showOtherSeries": false
            },
            "nrqlQueries": [
              {
                "accountId": "{{accountId}}",
                "query": "FROM MessageQueue SELECT uniqueCount(consumerGroupId) WHERE entityType = 'MESSAGE_QUEUE_CONSUMER_GROUP' FACET consumerGroup.state SINCE 5 minutes ago"
              }
            ]
          }
        },
        {
          "title": "Total Consumer Lag Trend",
          "layout": {
            "column": 5,
            "row": 1,
            "width": 8,
            "height": 3
          },
          "visualization": {
            "id": "viz.area"
          },
          "configuration": {
            "facet": {
              "showOtherSeries": false
            },
            "nrqlQueries": [
              {
                "accountId": "{{accountId}}",
                "query": "FROM MessageQueue SELECT sum(consumerGroup.totalLag) WHERE entityType = 'MESSAGE_QUEUE_CONSUMER_GROUP' TIMESERIES AUTO SINCE 1 hour ago"
              }
            ],
            "colors": {
              "seriesOverrides": [
                {
                  "seriesName": "Total Lag",
                  "color": "#F97C00"
                }
              ]
            }
          }
        },
        {
          "title": "Consumer Group Performance",
          "layout": {
            "column": 1,
            "row": 4,
            "width": 12,
            "height": 3
          },
          "visualization": {
            "id": "viz.table"
          },
          "configuration": {
            "facet": {
              "showOtherSeries": false
            },
            "nrqlQueries": [
              {
                "accountId": "{{accountId}}",
                "query": "FROM MessageQueue SELECT latest(consumerGroup.memberCount) AS 'Members', latest(consumerGroup.totalLag) AS 'Total Lag', rate(sum(consumerGroup.messagesConsumedPerSecond), 1 second) AS 'Msg/sec', latest(consumerGroup.state) AS 'State' WHERE entityType = 'MESSAGE_QUEUE_CONSUMER_GROUP' FACET consumerGroupId AS 'Consumer Group' SINCE 5 minutes ago"
              }
            ]
          }
        }
      ]
    }
  ]
}